pipeline {
    agent any

    environment {
        COMPILED_BRANCH=""
        PARENT_BUILD=""
        BUILD_VERSION_JENKINS=""
    }

    options {
        disableConcurrentBuilds()
        buildDiscarder logRotator(artifactDaysToKeepStr: '',
             artifactNumToKeepStr: '', 
             daysToKeepStr: '', 
             numToKeepStr: '50')
    }

    parameters {
        choice(name: 'build_configuration_type',
            choices: 'All\nDebug\nRelease',
            description: 'Which configuration do you want to build?')
        booleanParam(name: 'is_symbols_build',
	    default: true,
            description: 'Build with symbols information'),
        booleanParam(name: 'is_log_messages_build',
	    default: false,
            description: 'Build with debug log messages')
        gitParameter branch: '.*',
            branchFilter: '.*',
            defaultValue: 'develop', 
            description: '', 
            name: 'BRANCH', 
            quickFilterEnabled: true, 
            selectedValue: 'DEFAULT', 
            sortMode: 'ASCENDING_SMART', 
            tagFilter: '*', 
            type: 'PT_BRANCH'
    }

    stages {
        stage('Config check') {
            steps {
                echo 'Build parameters:'
                echo "build configuration: ${params.build_configuration_type}"
                echo "Debug logs: ${params.is_log_messages_build}"
                echo "Symbols: ${params.is_symbols_build}"
            }
        }

        stage('Checkout') {
            steps {
                script {
                    def str = params.BRANCH
                    BRANCH_NAME = str.substring(7)
                }
                git branch: "${BRANCH_NAME}" , url: 'git@github.com:guyker/HelloWorld-repo.git'
                 
            }
        }

        stage('Prepare environment variables') {
            steps {
                sh '''
                    COMPILED_BRANCH="${GIT_BRANCH##origin/}"
                    PARENT_BUILD=${BUILD_NUMBER}
                '''
            }
        }

        stage ('Build') {
            steps {
                sh '''#!/bin/bash
                    pwd

                    date
                    pwd
                    whoami

                    echo $UID
                    id

                    git push --tags
                    echo "----------------------------"

                    #mkdir /tmp/HelloWorld
                    #cd /tmp/HelloWorld

                    #cd /home/guy/work/HelloWorld-repo

                    cd src
                    gcc -v HelloWorld.cpp -o runme
                    env
                '''
            }
        }
    }
}

